<%- include('partials/head') %>
<body class="bg-gradient-to-b from-gray-900 via-black to-gray-900 text-white min-h-screen flex flex-col">

  <!-- Navbar -->
    <%- include('partials/navbar') %>

      <!-- Main Content -->
        <main class="flex-1 flex flex-col items-center justify-center p-6">
            
                <!-- Header -->
                    <header class="text-center mb-10">
                          <h1 class="text-4xl font-extrabold text-indigo-400 mb-2">Purchase FREP Token</h1>
                                <p class="text-gray-400">Connect your wallet to start buying</p>
                                    </header>

                                        <!-- Wallet Buttons -->
                                            <div id="wallet-section" class="mb-8">
                                                  <button id="connect-btn" class="px-6 py-3 bg-indigo-600 rounded-xl hover:bg-indigo-700 transition">
                                                          Connect Wallet
                                                                </button>
                                                                      <button id="disconnect-btn" class="hidden px-6 py-3 bg-red-600 rounded-xl hover:bg-red-700 transition ml-3">
                                                                              Disconnect
                                                                                    </button>
                                                                                        </div>

                                                                                            <!-- Calculator -->
                                                                                                <div class="bg-gray-800 rounded-2xl p-6 shadow-lg w-full max-w-md">
                                                                                                      <!-- Currency Icons -->
                                                                                                            <div class="flex justify-center space-x-6 mb-6">
                                                                                                                    <button class="currency-btn" data-symbol="SOL">
                                                                                                                              <img src="/img/sol.png" alt="SOL" class="h-10 inline"> 
                                                                                                                                      </button>
                                                                                                                                              <button class="currency-btn" data-symbol="USDT">
                                                                                                                                                        <img src="/img/usdt.png" alt="USDT" class="h-10 inline"> 
                                                                                                                                                                </button>
                                                                                                                                                                        <button class="currency-btn" data-symbol="USDC">
                                                                                                                                                                                  <img src="/img/usdc.png" alt="USDC" class="h-10 inline"> 
                                                                                                                                                                                          </button>
                                                                                                                                                                                                </div>

                                                                                                                                                                                                      <!-- FREP price -->
                                                                                                                                                                                                            <div class="text-center mb-4">
                                                                                                                                                                                                                    <p id="token-symbol" class="text-lg font-semibold text-indigo-300">FREP = 0.001$</p>
                                                                                                                                                                                                                          </div>

                                                                                                                                                                                                                                <!-- Input + USD value -->
                                                                                                                                                                                                                                      <div class="flex items-center justify-between mb-6">
                                                                                                                                                                                                                                              <input id="amount" type="number" min="0" placeholder="Amount" class="flex-1 px-3 py-2 rounded bg-gray-700 text-white">
                                                                                                                                                                                                                                                      <span class="ml-3">≈ <span id="usd-value">0</span> $</span>
                                                                                                                                                                                                                                                            </div>

                                                                                                                                                                                                                                                                  <!-- Buy Button -->
                                                                                                                                                                                                                                                                        <button id="buy-btn" class="w-full px-6 py-3 bg-green-600 rounded-xl hover:bg-green-700 disabled:opacity-50 transition" disabled>
                                                                                                                                                                                                                                                                                Buy Now
                                                                                                                                                                                                                                                                                      </button>
                                                                                                                                                                                                                                                                                          </div>

                                                                                                                                                                                                                                                                                            </main>

                                                                                                                                                                                                                                                                                              <!-- Footer -->
                                                                                                                                                                                                                                                                                                <footer class="bg-gray-900 py-4 text-center border-t border-gray-800">
                                                                                                                                                                                                                                                                                                    <div class="flex justify-center space-x-6 mb-2">
                                                                                                                                                                                                                                                                                                          <a href="#" class="hover:text-indigo-400">X</a>
                                                                                                                                                                                                                                                                                                                <a href="#" class="hover:text-indigo-400">Telegram</a>
                                                                                                                                                                                                                                                                                                                      <a href="#" class="hover:text-indigo-400">TikTok</a>
                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                              <div>
                                                                                                                                                                                                                                                                                                                                    <a href="/airdrop" class="text-indigo-400 hover:underline">Airdrop</a>
                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                          </footer>
                                                                                                                                                                                                                                                                                                                                          <script type="module">
                                                                                                                                                                                                                                                                                                                                              import { Connection, clusterApiUrl, PublicKey, SystemProgram, Transaction } from "https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.3/+esm";
                                                                                                                                                                                                                                                                                                                                                import { WalletAdapterNetwork } from "https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-base@0.9.23/+esm";
                                                                                                                                                                                                                                                                                                                                                  import { PhantomWalletAdapter } from "https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-phantom@0.9.23/+esm";
                                                                                                                                                                                                                                                                                                                                                    import { SolflareWalletAdapter } from "https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-solflare@0.9.23/+esm";

                                                                                                                                                                                                                                                                                                                                                      const connectBtn = document.getElementById('connect-btn');
                                                                                                                                                                                                                                                                                                                                                        const disconnectBtn = document.getElementById('disconnect-btn');
                                                                                                                                                                                                                                                                                                                                                          const buyBtn = document.getElementById('buy-btn');
                                                                                                                                                                                                                                                                                                                                                            const amountInput = document.getElementById('amount');
                                                                                                                                                                                                                                                                                                                                                              const usdValue = document.getElementById('usd-value');

                                                                                                                                                                                                                                                                                                                                                                let wallet = null;
                                                                                                                                                                                                                                                                                                                                                                  let connected = false;
                                                                                                                                                                                                                                                                                                                                                                    let currentCurrency = 'SOL';

                                                                                                                                                                                                                                                                                                                                                                      // اتصال مع شبكة سولانا
                                                                                                                                                                                                                                                                                                                                                                        const network = "<%= SITE.cluster %>" || "devnet";
                                                                                                                                                                                                                                                                                                                                                                          const connection = new Connection(clusterApiUrl(network), "confirmed");
                                                                                                                                                                                                                                                                                                                                                                            const merchant = new PublicKey("<%= SITE.merchant %>");

                                                                                                                                                                                                                                                                                                                                                                              // حساب السعر بالدولار
                                                                                                                                                                                                                                                                                                                                                                                document.querySelectorAll('.currency-btn').forEach(btn => {
                                                                                                                                                                                                                                                                                                                                                                                    btn.addEventListener('click', () => {
                                                                                                                                                                                                                                                                                                                                                                                          currentCurrency = btn.dataset.symbol;
                                                                                                                                                                                                                                                                                                                                                                                                calculate();
                                                                                                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                                                                                                      });
                                                                                                                                                                                                                                                                                                                                                                                                        amountInput.addEventListener('input', calculate);
                                                                                                                                                                                                                                                                                                                                                                                                          function calculate() {
                                                                                                                                                                                                                                                                                                                                                                                                              const amount = parseFloat(amountInput.value) || 0;
                                                                                                                                                                                                                                                                                                                                                                                                                  let price = 1;
                                                                                                                                                                                                                                                                                                                                                                                                                      if (currentCurrency === 'SOL') price = 20; // سعر تقريبي
                                                                                                                                                                                                                                                                                                                                                                                                                          usdValue.textContent = (amount * price).toFixed(2);
                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                              // المحافظ
                                                                                                                                                                                                                                                                                                                                                                                                                                const phantom = new PhantomWalletAdapter();
                                                                                                                                                                                                                                                                                                                                                                                                                                  const solflare = new SolflareWalletAdapter();

                                                                                                                                                                                                                                                                                                                                                                                                                                    async function connectWallet() {
                                                                                                                                                                                                                                                                                                                                                                                                                                        try {
                                                                                                                                                                                                                                                                                                                                                                                                                                              let choice = prompt("Choose wallet: 1) Phantom 2) Solflare");
                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (choice === "1") wallet = phantom;
                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (choice === "2") wallet = solflare;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (!wallet) return alert("No wallet chosen");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                      await wallet.connect();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            connected = true;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  connectBtn.classList.add('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        disconnectBtn.classList.remove('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              buyBtn.disabled = false;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.log("Connected:", wallet.publicKey.toBase58());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } catch (err) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              console.error("Wallet connect error:", err);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      function disconnectWallet() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (wallet) wallet.disconnect();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              connected = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  connectBtn.classList.remove('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      disconnectBtn.classList.add('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          buyBtn.disabled = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              async function buyNow() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (!connected || !wallet.publicKey) return alert("Please connect wallet first");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const amount = parseFloat(amountInput.value) || 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (amount <= 0) return alert("Enter amount first");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // نحول الـ amount الى lamports (1 SOL = 1e9 lamports)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const lamports = amount * 1e9;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // تجهيز معاملة ارسال
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const transaction = new Transaction().add(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  SystemProgram.transfer({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            fromPubkey: wallet.publicKey,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      toPubkey: merchant,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                lamports: lamports
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              );

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // الحصول على blockhash
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                transaction.feePayer = wallet.publicKey;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // التوقيع والإرسال
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const signed = await wallet.signTransaction(transaction);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const signature = await connection.sendRawTransaction(signed.serialize());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await connection.confirmTransaction(signature);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              alert(`✅ Success! Tx Signature: ${signature}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.log("Transaction successful:", signature);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } catch (err) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              console.error("Buy error:", err);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    alert("❌ Transaction failed: " + err.message);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            connectBtn.addEventListener('click', connectWallet);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              disconnectBtn.addEventListener('click', disconnectWallet);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                buyBtn.addEventListener('click', buyNow);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </html>